<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>YouTube管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a73e8;
            --primary-hover: #1557b0;
            --accent-green: #34c759;
            --accent-green-hover: #2ea44f;
            --danger-red: #ff3b30;
            --danger-red-hover: #cc3333;
            --neutral: #e8ecef;
            --neutral-hover: #dfe4e8;
            --text: #222;
            --text-secondary: #666;
            --bg-light: #f5f7fa;
            --bg-white: #fff;
            --border: #d1d5db;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, Roboto, sans-serif;
            background: var(--bg-light);
            color: var(--text);
            line-height: 1.5;
            padding: 8px;
            margin-bottom: 60px;
            min-height: 100vh;
            overscroll-behavior: none;
        }

        .container {
            background: var(--bg-white);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.1);
            max-width: 100%;
            margin: 0 auto;
        }

        h1 {
            font-size: clamp(1.4rem, 5vw, 1.6rem);
            text-align: center;
            margin-bottom: 8px;
        }

        h2 {
            font-size: clamp(1.2rem, 4vw, 1.3rem);
            margin-bottom: 10px;
        }

        h3 {
            font-size: clamp(1rem, 3.5vw, 1.1rem);
            margin-bottom: 12px;
        }

        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            line-height: 1.2;
        }

        textarea {
            height: 80px;
            resize: none;
        }

        button {
            padding: 10px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 48px;
            transition: background 0.2s, transform 0.1s;
            touch-action: manipulation;
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            background: var(--neutral);
            color: #aaa;
            cursor: not-allowed;
        }

        .primary-button {
            background: var(--primary);
            color: #fff;
        }

        .primary-button:hover, .primary-button:active {
            background: var(--primary-hover);
        }

        .secondary-button {
            background: var(--neutral);
            color: var(--text);
        }

        .secondary-button:hover, .secondary-button:active {
            background: var(--neutral-hover);
        }

        .import-button {
            background: var(--accent-green);
            color: #fff;
        }

        .import-button:hover, .import-button:active {
            background: var(--accent-green-hover);
        }

        .delete-button, .remove-button {
            background: var(--danger-red);
            color: #fff;
        }

        .delete-button:hover, .delete-button:active, .remove-button:hover, .remove-button:active {
            background: var(--danger-red-hover);
        }

        .toggle-videos-button {
            background: var(--neutral);
            color: var(--text);
        }

        .toggle-videos-button:hover, .toggle-videos-button:active {
            background: var(--neutral-hover);
        }

        .area {
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
            background: #fafafa;
        }

        #player-container {
            position: relative;
            padding-bottom: 56.25%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
            width: 100%;
        }

        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #currentPlaylist, #fsPresetList {
            list-style: none;
            padding: 0;
        }

        #currentPlaylist li, #fsPresetList li {
            background: var(--bg-white);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            min-height: 60px;
        }

        .list-item-content {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .list-item-content.clickable {
            cursor: pointer;
        }

        .list-item-content.clickable:active {
            background: #f1f3f4;
        }

        .list-item-thumbnail {
            width: 64px;
            height: 36px;
            object-fit: cover;
            border-radius: 4px;
            order: -1;
            margin-right: 12px;
            display: block;
        }

        .list-item-details {
            flex: 1;
            overflow: hidden;
        }

        .video-title, .preset-name {
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            display: block;
        }

        .video-id, .preset-type, .preset-video-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: block;
        }

        .list-item-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .preset-videos {
            margin-top: 10px;
            padding-left: 16px;
            border-left: 2px solid var(--border);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            width: 100%;
        }

        .preset-videos.expanded {
            max-height: 800px;
        }

        .preset-videos li {
            padding: 10px;
            margin-bottom: 6px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            min-height: 56px;
        }

        .user-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            margin-bottom: 12px;
        }

        .status-message {
            font-size: 0.9rem;
            margin-top: 6px;
        }

        .auth-status {
            color: var(--danger-red);
            font-weight: 500;
        }

        .warning {
            color: var(--danger-red);
            font-size: 0.9rem;
            text-align: center;
            border: 1px solid var(--danger-red);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .hidden {
            display: none !important;
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            margin-left: 6px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 10px;
            }

            h1 {
                font-size: 1.4rem;
            }

            h2 {
                font-size: 1.2rem;
            }

            h3 {
                font-size: 1rem;
            }

            input, textarea {
                font-size: 0.95rem;
                padding: 8px;
            }

            button {
                padding: 8px 12px;
                font-size: 0.95rem;
                min-width: 44px;
            }

            .list-item-content {
                flex: 1;
            }

            .list-item-thumbnail {
                width: 56px;
                height: 31.5px;
                margin-right: 10px;
            }

            .video-title, .preset-name {
                font-size: 0.85rem;
                max-width: 150px;
            }

            .video-id, .preset-type, .preset-video-count {
                font-size: 0.8rem;
            }

            .list-item-actions {
                gap: 6px;
            }

            .preset-videos li {
                padding: 8px;
                min-height: 52px;
            }

            #currentPlaylist li, #fsPresetList li {
                padding: 10px;
                min-height: 56px;
            }
        }

        @media (max-width: 480px) {
            .list-item-content {
                flex-direction: row;
                align-items: center;
                flex-wrap: nowrap;
                width: 100%;
            }

            .list-item-thumbnail {
                width: 48px;
                height: 27px;
                margin-right: 8px;
                margin-bottom: 0;
                order: -1;
                display: block;
            }

            .list-item-details {
                flex: 1;
                order: 0;
                min-width: 0;
            }

            .list-item-actions {
                width: auto;
                justify-content: flex-end;
                order: 1;
                padding-top: 0;
                gap: 4px;
            }

            button {
                padding: 6px 8px;
                min-width: 36px;
                font-size: 0.9rem;
            }

            .video-title, .preset-name {
                font-size: 0.8rem;
                max-width: 120px;
            }

            .video-id, .preset-type, .preset-video-count {
                font-size: 0.75rem;
            }

            .preset-videos .list-item-content {
                flex-direction: row;
                flex-wrap: nowrap;
            }

            .preset-videos .list-item-thumbnail {
                width: 48px;
                height: 27px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>YouTube管理</h1>
        <p class="warning">
            警告: このデモはテスト用です。本番環境では使用しないでください。
        </p>

        <div id="authArea" class="auth-area">
            <h2>ログイン</h2>
            <input type="text" id="fsUsername" placeholder="ユーザー名">
            <input type="password" id="fsPassword" placeholder="パスワード">
            <button id="fsRegisterButton" class="primary-button"><i class="fas fa-user-plus"></i></button>
            <button id="fsLoginButton" class="primary-button"><i class="fas fa-sign-in-alt"></i></button>
            <p id="fsAuthStatus" class="status-message auth-status"></p>
        </div>

        <div id="appArea" class="hidden">
            <div class="user-info-bar">
                <p><strong id="loggedInFsUsername"></strong></p>
                <button id="fsLogoutButton" class="secondary-button"><i class="fas fa-sign-out-alt"></i></button>
            </div>

            <div id="player-container">
                <div id="player"></div>
            </div>

            <div class="area">
                <h2>リスト作成</h2>
                <textarea id="videoUrlsForList" placeholder="YouTube URL/ID（改行で複数）"></textarea>
                <button id="addToListButton" class="primary-button"><i class="fas fa-plus"></i> <span id="addToListLoader" class="loader hidden"></span></button>
                <div id="addToListStatus" class="status-message"></div>
                <h3>リスト (<span id="currentPlaylistCount">0</span>)</h3>
                <ul id="currentPlaylist"></ul>
                <button id="playCurrentListButton" class="primary-button"><i class="fas fa-play"></i> リスト再生</button>
                <button id="clearListButton" class="secondary-button"><i class="fas fa-times"></i> クリア</button>
            </div>

            <div class="area">
                <h2>保存</h2>
                <input type="text" id="fsPresetName" placeholder="プリセット名">
                <button id="saveListPresetButton" class="primary-button"><i class="fas fa-save"></i> リスト保存</button>
                <button id="saveSinglePresetButton" class="secondary-button"><i class="fas fa-save"></i> 単一保存</button>
            </div>

            <div class="area">
                <h3>プリセット</h3>
                <ul id="fsPresetList"></ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
        import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuZ-eLAOagx_XHDpDp_e46n0Pt5uznTfA",
            authDomain: "yoop-89cc6.firebaseapp.com",
            projectId: "yoop-89cc6",
            storageBucket: "yoop-89cc6.firebasestorage.app",
            messagingSenderId: "254370608179",
            appId: "1:254370608179:web:bb5528ac0c6bfc1d59df46",
            measurementId: "G-32EJH8Y3JS"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        let player;
        let currentEditingPlaylist = [];
        let currentFsUserId = null;
        let currentFsUsername = null;
        const usersCollectionRef = collection(db, "standalone_users_yt_v2");
        const presetsCollectionRef = collection(db, "standalone_presets_yt_v2");

        const authAreaEl = document.getElementById('authArea');
        const appAreaEl = document.getElementById('appArea');
        const loggedInFsUsernameEl = document.getElementById('loggedInFsUsername');
        const fsAuthStatusEl = document.getElementById('fsAuthStatus');
        const fsUsernameInputEl = document.getElementById('fsUsername');
        const fsPasswordInputEl = document.getElementById('fsPassword');
        const fsPresetListEl = document.getElementById('fsPresetList');
        const fsPresetNameInputEl = document.getElementById('fsPresetName');
        const currentPlaylistEl = document.getElementById('currentPlaylist');
        const currentPlaylistCountEl = document.getElementById('currentPlaylistCount');
        const videoUrlsForListTextareaEl = document.getElementById('videoUrlsForList');
        const addToListStatusEl = document.getElementById('addToListStatus');
        const addToListLoaderEl = document.getElementById('addToListLoader');

        window.onYouTubeIframeAPIReady = function() {
            player = new YT.Player('player', {
                videoId: '',
                playerVars: { 'playsinline': 1, 'autoplay': 0, 'controls': 1, 'loop': 0 },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        };

        function onPlayerReady(event) {
            renderCurrentPlaylist();
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED && currentEditingPlaylist.length > 0) {
                const currentIndex = player.getPlaylistIndex();
                const nextIndex = (currentIndex + 1) % currentEditingPlaylist.length;
                player.loadPlaylist({
                    playlist: currentEditingPlaylist.map(v => v.id),
                    index: nextIndex
                });
            }
        }

        const ytApiTag = document.createElement('script');
        ytApiTag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(ytApiTag, firstScriptTag);

        async function simpleHash(text) {
            if (!text || typeof crypto === 'undefined' || !crypto.subtle || !crypto.subtle.digest) {
                return text + "_hashed_fallback";
            }
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(text);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (e) {
                return text + "_hash_error_fallback";
            }
        }

        document.getElementById('fsRegisterButton').addEventListener('click', async () => {
            const username = fsUsernameInputEl.value.trim();
            const password = fsPasswordInputEl.value;
            fsAuthStatusEl.textContent = '';
            if (!username || !password) {
                fsAuthStatusEl.textContent = 'ユーザー名とパスワードを入力';
                return;
            }
            if (password.length < 6) {
                fsAuthStatusEl.textContent = 'パスワードは6文字以上';
                return;
            }

            const hashedPassword = await simpleHash(password);
            fsAuthStatusEl.textContent = '登録中...';
            try {
                const q = query(usersCollectionRef, where("username_lc", "==", username.toLowerCase()));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    fsAuthStatusEl.textContent = 'このユーザー名は使用済み';
                    return;
                }

                await addDoc(usersCollectionRef, {
                    username: username,
                    username_lc: username.toLowerCase(),
                    hashedPassword: hashedPassword,
                    createdAt: serverTimestamp()
                });
                fsAuthStatusEl.textContent = '登録完了！ログインしてください';
                fsUsernameInputEl.value = '';
                fsPasswordInputEl.value = '';
            } catch (error) {
                fsAuthStatusEl.textContent('登録エラー');
            }
        });

        document.getElementById('fsLoginButton').addEventListener('click', async () => {
            const username = fsUsernameInputEl.value.trim();
            const password = fsPasswordInputEl.value;
            fsAuthStatusEl.textContent = '';
            if (!username || !password) {
                fsAuthStatusEl.textContent = 'ユーザー名とパスワードを入力';
                return;
            }

            const hashedPasswordAttempt = await simpleHash(password);
            fsAuthStatusEl.textContent = 'ログイン中...';
            try {
                const q = query(usersCollectionRef, where("username_lc", "==", username.toLowerCase()));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    fsAuthStatusEl.textContent = 'ユーザー名またはパスワードが違います';
                    return;
                }

                let loggedIn = false;
                querySnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.hashedPassword === hashedPasswordAttempt) {
                        currentFsUserId = doc.id;
                        currentFsUsername = userData.username;
                        localStorage.setItem('loggedInFsUserId_yt_v2', currentFsUserId);
                        localStorage.setItem('loggedInFsUsername_yt_v2', currentFsUsername);
                        loggedIn = true;
                    }
                });

                if (loggedIn) {
                    fsAuthStatusEl.textContent = '';
                    authAreaEl.classList.add('hidden');
                    appAreaEl.classList.remove('hidden');
                    loggedInFsUsernameEl.textContent = currentFsUsername;
                    fsUsernameInputEl.value = '';
                    fsPasswordInputEl.value = '';
                    loadFsPresets();
                    currentEditingPlaylist = [];
                    renderCurrentPlaylist();
                } else {
                    fsAuthStatusEl.textContent = 'ユーザー名またはパスワードが違います';
                }
            } catch (error) {
                fsAuthStatusEl.textContent = 'ログインエラー';
            }
        });

        document.getElementById('fsLogoutButton').addEventListener('click', () => {
            currentFsUserId = null;
            currentFsUsername = null;
            localStorage.removeItem('loggedInFsUserId_yt_v2');
            localStorage.removeItem('loggedInFsUsername_yt_v2');
            authAreaEl.classList.remove('hidden');
            appAreaEl.classList.add('hidden');
            loggedInFsUsernameEl.textContent = '';
            fsPresetListEl.innerHTML = '<li>ログインしてください</li>';
            currentEditingPlaylist = [];
            renderCurrentPlaylist();
        });

        function checkInitialLoginStatus() {
            const storedUserId = localStorage.getItem('loggedInFsUserId_yt_v2');
            const storedUsername = localStorage.getItem('loggedInFsUsername_yt_v2');
            if (storedUserId && storedUsername) {
                currentFsUserId = storedUserId;
                currentFsUsername = storedUsername;
                authAreaEl.classList.add('hidden');
                appAreaEl.classList.remove('hidden');
                loggedInFsUsernameEl.textContent = currentFsUsername;
                loadFsPresets();
            } else {
                appAreaEl.classList.add('hidden');
            }
        }

        function extractVideoID(urlOrId) {
            if (!urlOrId) return null;
            urlOrId = urlOrId.trim();
            const patterns = [
                /youtu\.be\/([^#\&\?]{11})/,
                /\?v=([^#\&\?]{11})/,
                /\&v=([^#\&\?]{11})/,
                /embed\/([^#\&\?]{11})/,
                /^([a-zA-Z0-9_-]{11})$/
            ];
            for (const pattern of patterns) {
                const match = urlOrId.match(pattern);
                if (match && match[1]) return match[1];
            }
            return null;
        }

        async function fetchVideoInfoFromNoembed(videoId) {
            try {
                const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                if (data.error) {
                    return { id: videoId, title: `動画 (ID: ${videoId})`, thumbnail: null };
                }
                return { id: videoId, title: data.title || `動画 (ID: ${videoId})`, thumbnail: data.thumbnail_url || null };
            } catch (e) {
                return { id: videoId, title: `動画 (ID: ${videoId})`, thumbnail: null };
            }
        }

        document.getElementById('addToListButton').addEventListener('click', async function() {
            const urlsText = videoUrlsForListTextareaEl.value;
            if (!urlsText.trim()) {
                addToListStatusEl.textContent = 'URL/IDを入力';
                return;
            }
            const urls = urlsText.split('\n').map(u => u.trim()).filter(u => u);
            if (urls.length === 0) {
                addToListStatusEl.textContent = '有効な入力なし';
                return;
            }

            addToListLoaderEl.classList.remove('hidden');
            this.disabled = true;
            addToListStatusEl.textContent = `処理中: ${urls.length}件`;
            let added = 0, skipped = 0, errored = 0;

            const promises = urls.map(async (urlOrId) => {
                const videoId = extractVideoID(urlOrId);
                if (!videoId) {
                    skipped++;
                    return null;
                }
                if (currentEditingPlaylist.find(v => v.id === videoId)) {
                    skipped++;
                    return null;
                }
                try {
                    return await fetchVideoInfoFromNoembed(videoId);
                } catch (e) {
                    errored++;
                    return { id: videoId, title: `動画 (ID: ${videoId})`, thumbnail: null };
                }
            });

            try {
                const results = await Promise.all(promises);
                results.filter(v => v && v.id).forEach(info => {
                    if (!currentEditingPlaylist.find(v => v.id === info.id)) {
                        currentEditingPlaylist.push(info);
                        added++;
                    } else {
                        skipped++;
                    }
                });
                renderCurrentPlaylist();
                videoUrlsForListTextareaEl.value = '';
                addToListStatusEl.textContent = `${added}件追加${skipped ? `, ${skipped}件スキップ` : ''}${errored ? `, ${errored}件エラー` : ''}`;
            } catch (error) {
                addToListStatusEl.textContent = 'エラー';
            } finally {
                addToListLoaderEl.classList.add('hidden');
                this.disabled = false;
                setTimeout(() => { addToListStatusEl.textContent = ''; }, 3000);
            }
        });

        function renderCurrentPlaylist() {
            currentPlaylistEl.innerHTML = '';
            currentPlaylistCountEl.textContent = currentEditingPlaylist.length;
            document.getElementById('playCurrentListButton').disabled = currentEditingPlaylist.length === 0;
            document.getElementById('saveSinglePresetButton').disabled = currentEditingPlaylist.length === 0;
            document.getElementById('saveListPresetButton').disabled = currentEditingPlaylist.length === 0;

            if (currentEditingPlaylist.length === 0) {
                currentPlaylistEl.innerHTML = '<li>リストは空です</li>';
                return;
            }
            currentEditingPlaylist.forEach((video, index) => {
                const li = document.createElement('li');
                const thumbSrc = video.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                li.innerHTML = `
                    <div class="list-item-content clickable" data-index="${index}">
                        <img class="list-item-thumbnail" src="${thumbSrc}" alt="${video.title || 'サムネイル'}" ${video.thumbnail ? '' : 'style="background:#ddd;"'}>
                        <div class="list-item-details">
                            <span class="video-title" title="${video.title || 'タイトルなし'}">${video.title || `動画 ${index + 1}`}</span>
                            <span class="video-id">(ID: ${video.id})</span>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <button class="remove-button" data-index="${index}"><i class="fas fa-trash"></i></button>
                    </div>`;
                currentPlaylistEl.appendChild(li);
            });

            currentPlaylistEl.querySelectorAll('.remove-button').forEach(b => b.addEventListener('click', function(e) {
                e.stopPropagation();
                currentEditingPlaylist.splice(parseInt(this.dataset.index, 10), 1);
                renderCurrentPlaylist();
            }));

            currentPlaylistEl.querySelectorAll('.list-item-content.clickable').forEach(c => c.addEventListener('click', function(e) {
                if (e.target.closest('.list-item-actions')) return;
                const startIndex = parseInt(this.dataset.index, 10);
                if (player && player.loadPlaylist && currentEditingPlaylist.length > 0) {
                    player.loadPlaylist({ playlist: currentEditingPlaylist.map(v => v.id), index: startIndex });
                } else {
                    alert("プレイヤー未準備またはリストが空");
                }
            }));
        }

        document.getElementById('clearListButton').addEventListener('click', () => {
            if (confirm("リストをクリアしますか？")) {
                currentEditingPlaylist = [];
                renderCurrentPlaylist();
                addToListStatusEl.textContent = '';
            }
        });

        document.getElementById('playCurrentListButton').addEventListener('click', () => {
            if (player && player.loadPlaylist && currentEditingPlaylist.length > 0) {
                player.loadPlaylist({ playlist: currentEditingPlaylist.map(v => v.id), index: 0 });
            } else {
                alert("プレイヤー未準備またはリストが空");
            }
        });

        async function savePresetToFirestore(presetData) {
            if (!currentFsUserId) {
                alert('ログインしてください');
                return false;
            }
            const presetName = fsPresetNameInputEl.value.trim();
            if (!presetName) {
                alert('プリセット名を入力');
                return false;
            }

            presetData.userId = currentFsUserId;
            presetData.username = currentFsUsername;
            presetData.name = presetName;
            presetData.createdAt = serverTimestamp();

            const q = query(presetsCollectionRef, where("userId", "==", currentFsUserId), where("name", "==", presetName));
            try {
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    if (!confirm(`"${presetName}" は存在します。上書き？`)) return false;
                    for (const docSnapshot of querySnapshot.docs) {
                        await deleteDoc(doc(presetsCollectionRef, docSnapshot.id));
                    }
                }
                await addDoc(presetsCollectionRef, presetData);
                fsPresetNameInputEl.value = '';
                loadFsPresets();
                alert(`"${presetName}" を保存`);
                return true;
            } catch (e) {
                alert("保存エラー");
                return false;
            }
        }

        document.getElementById('saveListPresetButton').addEventListener('click', () => {
            if (currentEditingPlaylist.length === 0) {
                alert('リストに動画がありません');
                return;
            }
            savePresetToFirestore({ type: 'list', videos: [...currentEditingPlaylist] });
        });

        document.getElementById('saveSinglePresetButton').addEventListener('click', () => {
            if (currentEditingPlaylist.length === 0) {
                alert('リストに動画がありません');
                return;
            }
            const firstVideo = currentEditingPlaylist[0];
            savePresetToFirestore({ type: 'single', videoId: firstVideo.id, title: firstVideo.title, thumbnail: firstVideo.thumbnail });
        });

        async function loadFsPresets() {
            if (!currentFsUserId) {
                fsPresetListEl.innerHTML = '<li>ログインしてください</li>';
                return;
            }
            fsPresetListEl.innerHTML = '<li>読み込み中...<span class="loader"></span></li>';
            try {
                const q = query(presetsCollectionRef, where("userId", "==", currentFsUserId), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                const presets = [];
                querySnapshot.forEach((doc) => {
                    presets.push({ id: doc.id, ...doc.data() });
                });
                fsPresetListEl.innerHTML = '';
                if (presets.length === 0) {
                    fsPresetListEl.innerHTML = '<li>プリセットなし</li>';
                    return;
                }
                presets.forEach((p) => {
                    let infoHtml = '', actionType = '';
                    const thumbSrcDefault = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    if (p.type === 'single' && p.videoId) {
                        const thumb = p.thumbnail || thumbSrcDefault;
                        infoHtml = `<img class="list-item-thumbnail" src="${thumb}" alt="${p.name}" ${!p.thumbnail ? 'style="background:#ddd;"' : ''}><div class="list-item-details"><span class="preset-name" title="${p.name}">${p.name}</span><span class="preset-type">(単一)</span></div>`;
                        actionType = 'single';
                    } else if (p.type === 'list' && p.videos && p.videos.length > 0) {
                        const first = p.videos[0];
                        const thumb = (first && first.thumbnail) || thumbSrcDefault;
                        infoHtml = `<img class="list-item-thumbnail" src="${thumb}" alt="${p.name}" ${!(first && first.thumbnail) ? 'style="background:#ddd;"' : ''}><div class="list-item-details"><span class="preset-name" title="${p.name}">${p.name}</span><span class="preset-video-count">(${p.videos.length}件)</span></div>`;
                        actionType = 'list';
                    } else {
                        infoHtml = `<div class="list-item-details"><span class="preset-name">${p.name}</span><span class="preset-type">(不明)</span></div>`;
                        actionType = '';
                    }
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="list-item-content">${infoHtml}</div>
                        <div class="list-item-actions">
                            <button class="import-button preset-import-btn" data-type="${actionType}" data-presetid="${p.id}" ${!actionType ? 'disabled' : ''}><i class="fas fa-download"></i></button>
                            ${p.type === 'list' ? `<button class="toggle-videos-button" data-presetid="${p.id}"><i class="fas fa-chevron-down"></i></button>` : ''}
                            <button class="delete-button preset-delete-btn" data-presetid="${p.id}" data-name="${p.name}"><i class="fas fa-trash"></i></button>
                        </div>`;
                    fsPresetListEl.appendChild(li);

                    if (p.type === 'list' && p.videos && p.videos.length > 0) {
                        const videosUl = document.createElement('ul');
                        videosUl.className = 'preset-videos';
                        p.videos.forEach((video, idx) => {
                            const thumbSrc = video.thumbnail || thumbSrcDefault;
                            const videoLi = document.createElement('li');
                            videoLi.innerHTML = `
                                <div class="list-item-content clickable" data-presetid="${p.id}" data-index="${idx}">
                                    <img class="list-item-thumbnail" src="${thumbSrc}" alt="${video.title || 'サムネイル'}" ${video.thumbnail ? '' : 'style="background:#ddd;"'}>
                                    <div class="list-item-details">
                                        <span class="video-title" title="${video.title || 'タイトルなし'}">${video.title || `動画 ${idx + 1}`}</span>
                                        <span class="video-id">(ID: ${video.id})</span>
                                    </div>
                                </div>
                                <div class="list-item-actions"></div>`;
                            videosUl.appendChild(videoLi);
                        });
                        li.appendChild(videosUl);
                    }
                });

                fsPresetListEl.querySelectorAll('.preset-import-btn').forEach(b => b.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const type = this.dataset.type;
                    const id = this.dataset.presetid;
                    const preset = presets.find(pr => pr.id === id);
                    if (!preset) {
                        alert("プリセットが見つかりません");
                        return;
                    }
                    let added = 0, skipped = 0;
                    if (type === 'single' && preset.videoId) {
                        const video = { id: preset.videoId, title: preset.title, thumbnail: preset.thumbnail };
                        if (!currentEditingPlaylist.find(v => v.id === video.id)) {
                            currentEditingPlaylist.push(video);
                            added++;
                        } else {
                            skipped++;
                        }
                    } else if (type === 'list' && preset.videos && preset.videos.length > 0) {
                        preset.videos.forEach(video => {
                            if (!currentEditingPlaylist.find(v => v.id === video.id)) {
                                currentEditingPlaylist.push(video);
                                added++;
                            } else {
                                skipped++;
                            }
                        });
                    }
                    renderCurrentPlaylist();
                    addToListStatusEl.textContent = `${added}件インポート${skipped ? `, ${skipped}件スキップ` : ''}`;
                    setTimeout(() => { addToListStatusEl.textContent = ''; }, 3000);
                }));

                fsPresetListEl.querySelectorAll('.preset-delete-btn').forEach(b => b.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const id = this.dataset.presetid;
                    const name = this.dataset.name;
                    if (confirm(`"${name}" を削除？`)) {
                        try {
                            await deleteDoc(doc(presetsCollectionRef, id));
                            loadFsPresets();
                        } catch (e) {
                            alert('削除エラー');
                        }
                    }
                }));

                fsPresetListEl.querySelectorAll('.toggle-videos-button').forEach(b => b.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const presetId = this.dataset.presetid;
                    const videosUl = this.closest('li').querySelector('.preset-videos');
                    const icon = this.querySelector('i');
                    if (videosUl.classList.contains('expanded')) {
                        videosUl.classList.remove('expanded');
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    } else {
                        videosUl.classList.add('expanded');
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                }));

                fsPresetListEl.querySelectorAll('.preset-videos .list-item-content.clickable').forEach(c => c.addEventListener('click', function(e) {
                    if (e.target.closest('.list-item-actions')) return;
                    const presetId = this.dataset.presetid;
                    const startIndex = parseInt(this.dataset.index, 10);
                    const preset = presets.find(pr => pr.id === presetId);
                    if (player && preset && preset.videos && preset.videos.length > 0) {
                        player.loadPlaylist({ playlist: preset.videos.map(v => v.id), index: startIndex });
                    } else {
                        alert("プレイヤー未準備またはリストが空");
                    }
                }));
            } catch (e) {
                if (e.message.includes("The query requires an index")) {
                    fsPresetListEl.innerHTML = '<li>読み込みエラー。インデックスを作成: <a href="https://console.firebase.google.com/v1/r/project/yoop-89cc6/firestore/indexes?create_composite=Cltwcm9qZWN0cy95b29wLTg5Y2M2L2RhdGFiYXNlcy8oZGVmYXVsdCkvY29sbGVjdGlvbkdyb3Vwcy9zdGFuZGFsb25lX3ByZXNldHNfeXRfdjIvaW5kZXhlcy9fEAEaCgoGdXNlcklkEAEaDQoJY3JlYXRlZEF0EAIaDAoIX19uYW1lX18QAg" target="_blank">インデックス</a></li>';
                } else {
                    fsPresetListEl.innerHTML = `<li>読み込みエラー: ${e.message}</li>`;
                }
            }
        }

        checkInitialLoginStatus();
    </script>
</body>
</html>
